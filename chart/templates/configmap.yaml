{{- if or .Values.conf .Values.custom_conf }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "postgres.fullname" . }}-config
  labels:
    {{- include "postgres.labels" . | nindent 4 }}
data:
  postgresql.conf: |
    {{- if .Values.custom_conf }}
    # Custom PostgreSQL configuration
    {{ .Values.custom_conf | nindent 4 }}
    {{- else }}
    # PostgreSQL configuration generated by Helm chart

    # Connection settings
    listen_addresses = '*'
    port = 5432

    {{- $memoryLimitBytes := 0 }}
    {{- if .Values.resources.limits.memory }}
      {{- if hasSuffix "Gi" .Values.resources.limits.memory }}
        {{- $memoryLimitBytes = mul (trimSuffix "Gi" .Values.resources.limits.memory | int) 1073741824 }}
      {{- else if hasSuffix "Mi" .Values.resources.limits.memory }}
        {{- $memoryLimitBytes = mul (trimSuffix "Mi" .Values.resources.limits.memory | int) 1048576 }}
      {{- else if hasSuffix "G" .Values.resources.limits.memory }}
        {{- $memoryLimitBytes = mul (trimSuffix "G" .Values.resources.limits.memory | int) 1000000000 }}
      {{- else if hasSuffix "M" .Values.resources.limits.memory }}
        {{- $memoryLimitBytes = mul (trimSuffix "M" .Values.resources.limits.memory | int) 1000000 }}
      {{- end }}
    {{- end }}

    {{- if $memoryLimitBytes }}
      {{- $sharedBuffers := div $memoryLimitBytes 4 }}
      {{- $effectiveCacheSize := div (mul $memoryLimitBytes 3) 4 }}
      {{- $workMem := div $memoryLimitBytes 200 }}
      {{- $maintenanceWorkMem := div $memoryLimitBytes 16 }}
      {{- $walBuffers := div $memoryLimitBytes 128 }}

    # Memory settings (auto-tuned based on resource limits)
    {{- range $key, $value := .Values.conf }}
    {{- if eq $key "shared_buffers" }}
    shared_buffers = {{ $value | default (printf "%dB" $sharedBuffers) }}
    {{- else if eq $key "effective_cache_size" }}
    effective_cache_size = {{ $value | default (printf "%dB" $effectiveCacheSize) }}
    {{- else if eq $key "work_mem" }}
    work_mem = {{ $value | default (printf "%dB" $workMem) }}
    {{- else if eq $key "maintenance_work_mem" }}
    maintenance_work_mem = {{ $value | default (printf "%dB" $maintenanceWorkMem) }}
    {{- else if eq $key "wal_buffers" }}
    wal_buffers = {{ $value | default (printf "%dB" $walBuffers) }}
    {{- else if $value }}
    {{ $key }} = {{ $value | quote }}
    {{- end }}
    {{- end }}
    {{- else }}

    # Memory settings (defaults)
    {{- range $key, $value := .Values.conf }}
    {{- if $value }}
    {{ $key }} = {{ $value | quote }}
    {{- end }}
    {{- end }}
    {{- end }}

    # Logging
    log_destination = 'stderr'
    logging_collector = off
    log_min_messages = warning
    log_min_error_statement = error
    log_line_prefix = '%t [%p]: user=%u,db=%d '

    # Authentication
    password_encryption = scram-sha-256
    {{- end }}
{{- end }}
