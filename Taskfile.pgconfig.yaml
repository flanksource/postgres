version: "3"

# GitHub Actions output grouping
output:
  group:
    begin: "::group::{{.TASK}}"
    end: "::endgroup::"

vars:
  CLI_NAME: "postgres-cli"
  GOBIN: '{{.GOBIN | default "$(go env GOPATH)/bin"}}'
  VERSION:
    sh: git describe --tags --always --dirty 2>/dev/null || echo "dev"
  GIT_COMMIT:
    sh: git rev-parse --short HEAD 2>/dev/null || echo "unknown"
  BUILD_DATE:
    sh: date -u '+%Y-%m-%dT%H:%M:%SZ'

tasks:
  build:
    desc: Build the postgres-cli and install to GOBIN
    vars:
      GOBIN_PATH:
        sh: go env GOPATH
      LDFLAGS: >-
        -s -w
        -X 'main.Version={{.VERSION}}'
        -X 'main.GitCommit={{.GIT_COMMIT}}'
        -X 'main.BuildDate={{.BUILD_DATE}}'
    cmds:
      - echo "Building {{.CLI_NAME}} {{.VERSION}} ({{.GIT_COMMIT}})..."
      - >-
        go build
        -ldflags "{{.LDFLAGS}}"
        -o "{{.GOBIN_PATH}}/bin/{{.CLI_NAME}}"
        ./cmd
      - echo "âœ… Built and installed {{.CLI_NAME}} to {{.GOBIN_PATH}}/bin"
    method: timestamp

  install:
    desc: Install the CLI to GOBIN (alias for build)
    cmds:
      - task: build

  test:
    desc: Run all CLI-related tests
    cmds:
      - echo "Running CLI tests..."
      - go test ./cmd/... ./pkg/... -v -cover
      - echo "âœ… CLI tests passed"

  ci:
    desc: Run complete CI pipeline for CLI
    cmds:
      - task: check-dependencies
      - task: build
      - task: test
      - echo "ðŸŽ‰ CLI CI pipeline completed successfully"

  fmt:
    desc: Format CLI code
    cmds:
      - echo "Formatting CLI code..."
      - go fmt ./cmd/... ./pkg/...
      - echo "âœ… CLI code formatted"

  lint:
    desc: Lint CLI code
    cmds:
      - echo "Linting CLI code..."
      - go vet ./cmd/... ./pkg/...
      - echo "âœ… CLI code linting completed"
